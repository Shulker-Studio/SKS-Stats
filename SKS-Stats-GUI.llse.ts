// LiteLoader-AIDS automatic generated
/// <reference path="F:\MC\000_Dev\003_Lib\dts/dts/llaids/src/index.d.ts"/> 

ll.registerPlugin(
    /* name */ "SKS-Stats-GUI",
    /* introduction */ "SKS统计信息GUI",
    /* version */[0, 0, 1],
    /* otherInformation */ {}
);

let lang = {
    zh_CN: {
        //custom
        "minecraft:animals_bred": "繁殖动物次数",
        "minecraft:clean_armor": "清洗盔甲次数",
        "minecraft:clean_banner": "清洗旗帜次数",
        "minecraft:open_barrel": "木桶打开次数",
        "minecraft:bell_ring": "鸣钟次数",
        "minecraft:eat_cake_slice": "吃掉的蛋糕片数",
        "minecraft:fill_cauldron": "炼药锅装水次数",
        "minecraft:open_chest": "箱子打开次数",
        "minecraft:damage_absorbed": "吸收的伤害",
        "minecraft:damage_blocked_by_shield": "盾牌抵挡的伤害",
        "minecraft:damage_dealt": "造成伤害",
        "minecraft:damage_dealt_absorbed": "造成伤害（被吸收）",
        "minecraft:damage_dealt_resisted": "造成伤害（被抵挡）",
        "minecraft:damage_resisted": "抵挡的伤害",
        "minecraft:damage_taken": "受到伤害",
        "minecraft:inspect_dispenser": "搜查发射器次数",
        "minecraft:boat_one_cm": "坐船移动距离(厘米)",
        "minecraft:aviate_one_cm": "鞘翅滑行距离(厘米)",
        "minecraft:horse_one_cm": "骑马移动距离(厘米)",
        "minecraft:minecart_one_cm": "坐矿车移动距离(厘米)",
        "minecraft:pig_one_cm": "骑猪移动距离(厘米)",
        "minecraft:strider_one_cm": "骑炽足兽移动距离(厘米)",
        "minecraft:climb_one_cm": "已攀爬距离(厘米)",
        "minecraft:crouch_one_cm": "潜行距离(厘米)",
        "minecraft:fall_one_cm": "摔落高度(厘米)",
        "minecraft:fly_one_cm": "飞行距离(厘米)",
        "minecraft:sprint_one_cm": "疾跑距离(厘米)",
        "minecraft:swim_one_cm": "游泳距离(厘米)",
        "minecraft:walk_one_cm": "行走距离(厘米)",
        "minecraft:walk_on_water_one_cm": "水面行走距离(厘米)",
        "minecraft:walk_under_water_one_cm": "水下行走距离(厘米)",
        "minecraft:inspect_dropper": "搜查投掷器次数",
        "minecraft:open_enderchest": "末影箱打开次数",
        "minecraft:fish_caught": "捕鱼数",
        "minecraft:leave_game": "游戏退出次数",
        "minecraft:inspect_hopper": "搜查漏斗次数",
        "minecraft:interact_with_anvil": "与铁砧交互次数",
        "minecraft:interact_with_beacon": "与信标交互次数",
        "minecraft:interact_with_blast_furnace": "与高炉交互次数",
        "minecraft:interact_with_brewingstand": "与酿造台交互次数",
        "minecraft:interact_with_campfire": "与营火交互次数",
        "minecraft:interact_with_cartography_table": "与制图台交互次数",
        "minecraft:interact_with_crafting_table": "与工作台交互次数",
        "minecraft:interact_with_furnace": "与熔炉交互次数",
        "minecraft:interact_with_grindstone": "与砂轮交互次数",
        "minecraft:interact_with_lectern": "与讲台交互次数",
        "minecraft:interact_with_loom": "与织布机交互次数",
        "minecraft:interact_with_smithing_table": "与锻造台交互次数",
        "minecraft:interact_with_smoker": "与烟熏炉交互次数",
        "minecraft:interact_with_stonecutter": "与切石机交互次数",
        "minecraft:drop": "物品掉落",
        "minecraft:enchant_item": "物品附魔次数",
        "minecraft:jump": "跳跃次数",
        "minecraft:mobs_kills": "生物击杀数",
        "minecraft:play_record": "播放唱片数",
        "minecraft:play_noteblock": "音符盒播放次数",
        "minecraft:tune_noteblock": "音符盒调音次数",
        "minecraft:deaths": "死亡次数",
        "minecraft:pot_flower": "盆栽种植数",
        "minecraft:player_kills": "玩家击杀数",
        "minecraft:raid_trigger": "触发袭击次数",
        "minecraft:raid_win": "袭击胜利次数",
        "minecraft:clean_shulker_box": "潜影盒清洗次数",
        "minecraft:open_shulker_box": "潜影盒打开次数",
        "minecraft:time_since_death": "自上次死亡(Tick)",
        "minecraft:time_since_rest": "自上次入眠(Tick)",
        "minecraft:sneak_time": "潜行时间(Tick)",
        "minecraft:talked_to_villager": "村民交互次数",
        "minecraft:target_hit": "击中标靶次数",
        "minecraft:play_time": "游戏时间(Tick)",
        "minecraft:total_world_time": "世界打开时间(Tick)",
        "minecraft:sleep_in_bed": "躺在床上的次数",
        "minecraft:traded_with_villager": "村民交易次数",
        "minecraft:trigger_trapped_chest": "陷阱箱触发次数",
        "minecraft:use_cauldron": "从炼药锅取水次数",
        //实体
        "minecraft:agent": "智能体",
        "minecraft:allay": "悦灵",
        "minecraft:area_effect_cloud": "区域效果云",
        "minecraft:armor_stand": "盔甲架",
        "minecraft:arrow": "箭",
        "minecraft:axolotl": "美西螈",
        "minecraft:balloon": "气球",
        "minecraft:bat": "蝙蝠",
        "minecraft:bee": "蜜蜂",
        "minecraft:blaze": "烈焰人",
        "minecraft:boat": "船",
        "minecraft:camel": "骆驼",
        "minecraft:cat": "流浪猫",
        "minecraft:cave_spider": "洞穴蜘蛛",
        "minecraft:chalkboard": "黑板",
        "minecraft:chest_boat": "运输船",
        "minecraft:chest_minecart": "运输矿车",
        "minecraft:chicken": "鸡",
        "minecraft:cod": "鳕鱼",
        "minecraft:command_block_minecart": "命令方块矿车",
        "minecraft:cow": "牛",
        "minecraft:creeper": "苦力怕",
        "minecraft:dolphin": "海豚",
        "minecraft:donkey": "驴",
        "minecraft:dragon_fireball": "末影龙火球",
        "minecraft:drowned": "溺尸",
        "minecraft:egg": "鸡蛋",
        "minecraft:elder_guardian": "远古守卫者",
        "minecraft:elder_guardian_ghost": "远古守卫者幽灵",
        "minecraft:ender_crystal": "末地水晶",
        "minecraft:ender_dragon": "末影龙",
        "minecraft:ender_pearl": "末影珍珠",
        "minecraft:enderman": "末影人",
        "minecraft:endermite": "末影螨",
        "minecraft:evocation_fang": "尖牙",
        "minecraft:evocation_illager": "唤魔者",
        "minecraft:eye_of_ender_signal": "末影之眼",
        "minecraft:falling_block": "下落的方块",
        "minecraft:fireball": "恶魂火球",
        "minecraft:fireworks_rocket": "烟花火箭",
        "minecraft:fishing_hook": "浮漂",
        "minecraft:fox": "狐狸",
        "minecraft:frog": "青蛙",
        "minecraft:ghast": "恶魂",
        "minecraft:glow_squid": "发光鱿鱼",
        "minecraft:goat": "山羊",
        "minecraft:guardian": "守卫者",
        "minecraft:hoglin": "疣猪兽",
        "minecraft:hopper_minecart": "漏斗矿车",
        "minecraft:horse": "马",
        "minecraft:husk": "尸壳",
        "minecraft:ice_bomb": "冰弹",
        "minecraft:iron_golem": "铁傀儡",
        "minecraft:item": "掉落物",
        "minecraft:leash_knot": "拴绳结",
        "minecraft:lightning_bolt": "闪电",
        "minecraft:lingering_potion": "滞留药水",
        "minecraft:llama": "羊驼",
        "minecraft:llama_spit": "羊驼唾沫",
        "minecraft:magma_cube": "岩浆怪",
        "minecraft:minecart": "矿车",
        "minecraft:mooshroom": "哞菇",
        "minecraft:moving_block": "移动的方块",
        "minecraft:mule": "骡",
        "minecraft:npc": "NPC",
        "minecraft:ocelot": "豹猫",
        "minecraft:painting": "画",
        "minecraft:panda": "熊猫",
        "minecraft:parrot": "鹦鹉",
        "minecraft:phantom": "幻翼",
        "minecraft:pig": "猪",
        "minecraft:piglin": "猪灵",
        "minecraft:piglin_brute": "猪灵蛮兵",
        "minecraft:pillager": "掠夺者",
        "minecraft:player": "玩家",
        "minecraft:polar_bear": "北极熊",
        "minecraft:pufferfish": "河豚",
        "minecraft:rabbit": "兔子",
        "minecraft:ravager": "劫掠兽",
        "minecraft:salmon": "鲑鱼",
        "minecraft:sheep": "绵羊",
        "minecraft:shield": "盾牌",
        "minecraft:shulker": "潜影贝",
        "minecraft:shulker_bullet": "潜影弹",
        "minecraft:silverfish": "蠹虫",
        "minecraft:skeleton": "骷髅",
        "minecraft:skeleton_horse": "骷髅马",
        "minecraft:slime": "史莱姆",
        "minecraft:small_fireball": "小火球",
        "minecraft:sniffer": "嗅探兽",
        "minecraft:snow_golem": "雪傀儡",
        "minecraft:snowball": "雪球",
        "minecraft:spider": "蜘蛛",
        "minecraft:splash_potion": "喷溅药水",
        "minecraft:squid": "鱿鱼",
        "minecraft:stray": "流浪者",
        "minecraft:strider": "炽足兽",
        "minecraft:tadpole": "蝌蚪",
        "minecraft:thrown_trident": "三叉戟",
        "minecraft:tnt": "点燃的TNT",
        "minecraft:tnt_minecart": "TNT矿车",
        "minecraft:trader_llama": "行商羊驼",
        "minecraft:tripod_camera": "相机",
        "minecraft:tropicalfish": "热带鱼",
        "minecraft:turtle": "海龟",
        "minecraft:vex": "恼鬼",
        "minecraft:villager": "旧版村民",
        "minecraft:villager_v2": "村民",
        "minecraft:vindicator": "卫道士",
        "minecraft:wandering_trader": "流浪商人",
        "minecraft:warden": "监守者",
        "minecraft:witch": "女巫",
        "minecraft:wither": "凋灵",
        "minecraft:wither_skeleton": "凋灵骷髅",
        "minecraft:wither_skull": "凋灵之首",
        "minecraft:wither_skull_dangerous": "蓝色凋灵之首",
        "minecraft:wolf": "狼",
        "minecraft:xp_bottle": "附魔之瓶",
        "minecraft:xp_orb": "经验球",
        "minecraft:zoglin": "僵尸疣猪兽",
        "minecraft:zombie": "僵尸",
        "minecraft:zombie_horse": "僵尸马",
        "minecraft:zombie_pigman": "僵尸猪灵",
        "minecraft:zombie_villager": "僵尸村民",
        "minecraft:zombie_villager_v2": "僵尸村民"
        //item
    }
}
enum StatsType {
    Custom,
    Mined,
    Broken,
    Crafted,
    Used,
    Picked_Up,
    Dropped,
    Killed,
    Killed_By
}

let getPlayerStats: null | ((uuid: string, type?: StatsType) => string) = null

mc.listen('onServerStarted', () => {
    if (ll.hasExported('SKS-Stats', 'getPlayerData')) {
        getPlayerStats = ll.imports('SKS-Stats', 'getPlayerData')
    }
    regCommand()
})
function regCommand() {
    let cmd = mc.newCommand('stats', '玩家统计信息', PermType.Any)
    cmd.setEnum('type', [
        'custom',
        'mined',
        'broken',
        'crafted',
        'used',
        'picked_up',
        'dropped',
        'killed',
        'killed_by',
        'gui'
    ])
    cmd.mandatory('type', ParamType.Enum, 'type', 1)
    cmd.overload(['type'])
    cmd.setCallback((_cmd, origin, output, result) => {
        if (!origin.player) return output.error('该指令仅限玩家使用')
        let pl = origin.player
        log(result)
        switch (result.type) {
            case 'gui':
                return sendMainGui(pl)
            case 'custom':
                return sendStatsGui(pl, StatsType.Custom)
            case 'killed':
                return sendStatsGui(pl, StatsType.Killed)
            case 'killed_by':
                return sendStatsGui(pl, StatsType.Killed_By)
            case 'mined':
            case 'used':
            case 'picked_up':
            case 'dropped':
            case 'broken':
            case 'crafted':
                return output.success('todo')
            default:
                return output.error('未知参数')
        }
    })
    cmd.setup()
}
function sendMainGui(player: Player) {
    let fm = mc.newSimpleForm()
        .setTitle('玩家统计信息')
        .addButton('通用')
        .addButton('击杀')
        .addButton('被击杀')
    player.sendForm(fm, (player, id) => {
        switch (id) {
            case 0:
                return sendStatsGui(player, StatsType.Custom)
            case 1:
                return sendStatsGui(player, StatsType.Killed)
            case 2:
                return sendStatsGui(player, StatsType.Killed_By)
            default:
                return
        }
    })
}

function sendStatsGui(player: Player, type: StatsType) {
    if (getPlayerStats === null) return logger.error('未检测到前置插件SKS-Stats')
    let data = getPlayerStats(player.uuid, type)
    //log(data)
    if (!data) return player.tell('获取数据失败,请联系管理员')
    let statsData: [string, number][]
    try {
        let playerStatsData: { [key: string]: number } = JSON.parse(data)
        statsData = Object.entries(playerStatsData)
    } catch (err) {
        return logger.error('玩家数据解析失败')
    }
    let content = ''
    statsData.forEach(v => {
        let name = typeof lang.zh_CN[v[0]] === 'undefined' ? v[0] : lang.zh_CN[v[0]]
        content += ` - ${Format.Gold}${name}${Format.Clear} : ${Format.Green}${v[1]}${Format.Clear}\n`
    })
    let fm = mc.newSimpleForm()
        .setTitle(`统计信息-${StatsType[type]}`)
        .setContent(content)

    player.sendForm(fm, () => {

    })
}
